name: QA Release Changes

on:
  workflow_dispatch:
    inputs:
      label:
        description: "PR label to filter (e.g. feature-marketplace)"
        required: true
      callback_url:
        description: "ActivePieces webhook callback URL"
        required: true

jobs:
  compute-changes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # gh is already available on ubuntu-latest
      - name: Verify GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh --version
          gh auth status

      - name: Make script executable
        run: chmod +x scripts/list-release-prs.sh

      - name: Run QA release diff script
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ./scripts/list-release-prs.sh \
            --from-tfvars \
            --label "${{ inputs.label }}" \
            > output.txt

          echo "===== SCRIPT OUTPUT ====="
          cat output.txt

          cp output.txt payload.json

      - name: Send result back to ActivePieces
        run: |
          curl -X POST "${{ inputs.callback_url }}" \
            -H "Content-Type: application/json" \
            --data @payload.json
